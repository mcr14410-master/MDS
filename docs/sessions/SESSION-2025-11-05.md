# Session 2025-11-05 - Woche 6 Backend (Programme & File Upload)

**Datum:** 05.11.2025  
**Dauer:** ~3 Stunden  
**Phase:** Phase 2, Monat 2, Woche 6  
**Status:** Backend âœ… KOMPLETT | Frontend âŒ OFFEN

---

## ğŸ¯ Ziel der Session

**Woche 6: Programme & File Upload - Backend**
- File Upload Middleware (Multer)
- Programs CRUD API
- File Validation
- Testing

---

## âœ… Was wurde erreicht

### 1. **File Upload Middleware** (uploadMiddleware.js)
```javascript
âœ… Multer konfiguriert
âœ… 15 Dateitypen unterstÃ¼tzt (.nc, .mpf, .spf, .h, .eia, .txt, .cnc, .tap, .gcode, .fan, .min, .prg, .pim, .din, .iso)
âœ… Max. DateigrÃ¶ÃŸe: 100 MB
âœ… Upload-Verzeichnis: /uploads/programs/
âœ… Eindeutige Dateinamen (timestamp-random-originalname)
âœ… File-Type Validierung
âœ… Error-Handling (Multer Errors)
```

**Features:**
- Storage-Config mit eindeutigen Filenames
- File-Filter fÃ¼r erlaubte Extensions
- Error-Handler fÃ¼r Upload-Fehler
- Automatische Verzeichnis-Erstellung

---

### 2. **Programs Controller** (programsController.js)
```javascript
âœ… createProgram - Programm hochladen (File + DB-Eintrag)
âœ… getPrograms - Liste aller Programme (mit Filter)
âœ… getProgramById - Details + alle Revisionen
âœ… updateProgram - Metadaten Ã¤ndern
âœ… deleteProgram - LÃ¶schen (inkl. Files)
âœ… downloadProgram - File herunterladen
```

**Features:**
- File-Hash Berechnung (SHA-256)
- Content in DB speichern (fÃ¼r Syntax-Highlighting spÃ¤ter)
- Automatische Versionierung (1.0.0 bei Upload)
- Workflow-State (draft)
- JOIN mit operations, parts, machines, users
- CASCADE Delete (Program â†’ Revisions)
- File Cleanup bei Fehler
- Transaction-Support fÃ¼r Daten-Konsistenz

**Helpers:**
- `calculateFileHash()` - SHA-256 Hash
- `readFileContent()` - Content als Text
- `getNextVersion()` - NÃ¤chste Versionsnummer

---

### 3. **Programs Routes** (programsRoutes.js)
```javascript
âœ… POST   /api/programs              - Programm hochladen (Multipart)
âœ… GET    /api/programs              - Alle Programme
âœ… GET    /api/programs?operation_id=1 - Filter nach Operation
âœ… GET    /api/programs/:id          - Details + Revisionen
âœ… GET    /api/programs/:id/download - Download
âœ… PUT    /api/programs/:id          - Metadaten Ã¤ndern
âœ… DELETE /api/programs/:id          - LÃ¶schen
```

**Features:**
- Alle Routes mit Authentication
- Multer Middleware fÃ¼r Upload
- Error-Handler fÃ¼r Multer

---

### 4. **Testing** (test-programs.http)
```
âœ… 15 Tests erstellt:
  - CREATE mit verschiedenen Dateitypen
  - GET ALL
  - GET BY OPERATION (Filter)
  - GET BY ID
  - UPDATE
  - DOWNLOAD
  - Error-Szenarien (ohne Datei, ohne Pflichtfelder, falsche Operation)
  - DELETE
```

**Test Coverage:**
- âœ… Happy Path (Upload â†’ Liste â†’ Details â†’ Download â†’ Delete)
- âœ… Error Handling (400, 404)
- âœ… File Validierung
- âœ… Multiple Dateitypen (.nc, .mpf, .h, .eia, .txt)

---

### 5. **Test Files**
```
âœ… test-program.nc - NC-Programm fÃ¼r Tests
âœ… test-file-upload.http - 7 Upload-Tests
âœ… test-programs.http - 15 Programs API Tests
```

---

### 6. **Server Updates** (server.js v1.2.0)
```javascript
âœ… uploadMiddleware importiert
âœ… programsRoutes registriert
âœ… Test-Endpoint /api/test/upload
âœ… Console.log aktualisiert (siehe unten)
```

---

## ğŸ› Bugs gefixed

### **Bug #1: Spaltenname falsch**
```
Problem: "Spalte o.operation_number existiert nicht"
Ursache: DB-Spalten heiÃŸen op_number und op_name
Fix: AS-Aliase hinzugefÃ¼gt (o.op_number as operation_number)
```

**Betroffene Funktionen:**
- `getPrograms()` - Zeile ~128
- `getProgramById()` - Zeile ~170

---

## ğŸ“Š Statistiken

**Neue Dateien:** 5
- uploadMiddleware.js (118 Zeilen)
- programsController.js (360 Zeilen)
- programsRoutes.js (30 Zeilen)
- test-program.nc (24 Zeilen)
- test-file-upload.http (140 Zeilen)
- test-programs.http (260 Zeilen)

**GeÃ¤nderte Dateien:** 1
- server.js (v1.1.0 â†’ v1.2.0)

**Gesamt Code:** ~930 Zeilen

**Tests:** 22 (7 Upload + 15 Programs API)

---

## ğŸ“‚ Dateistruktur

```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”œâ”€â”€ authController.js
â”‚   â”‚   â”œâ”€â”€ partsController.js
â”‚   â”‚   â”œâ”€â”€ operationsController.js
â”‚   â”‚   â””â”€â”€ programsController.js         â† NEU
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ authRoutes.js
â”‚   â”‚   â”œâ”€â”€ partsRoutes.js
â”‚   â”‚   â”œâ”€â”€ operationsRoutes.js
â”‚   â”‚   â””â”€â”€ programsRoutes.js             â† NEU
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”œâ”€â”€ authMiddleware.js
â”‚   â”‚   â”œâ”€â”€ auditLogMiddleware.js
â”‚   â”‚   â””â”€â”€ uploadMiddleware.js           â† NEU
â”‚   â””â”€â”€ server.js                          â† AKTUALISIERT
â”œâ”€â”€ uploads/
â”‚   â””â”€â”€ programs/                          â† NEU (automatisch erstellt)
â”œâ”€â”€ test-program.nc                        â† NEU
â”œâ”€â”€ test-file-upload.http                  â† NEU
â””â”€â”€ test-programs.http                     â† NEU
```

---

## ğŸ”§ API Endpoints (Gesamt)

### **Auth:**
- POST /api/auth/register
- POST /api/auth/login
- GET  /api/auth/me
- POST /api/auth/change-password

### **Parts:**
- GET    /api/parts
- GET    /api/parts/:id
- POST   /api/parts
- PUT    /api/parts/:id
- DELETE /api/parts/:id
- GET    /api/parts/stats

### **Operations:**
- GET    /api/operations
- GET    /api/operations/:id
- POST   /api/operations
- PUT    /api/operations/:id
- DELETE /api/operations/:id

### **Programs:** â† NEU
- POST   /api/programs
- GET    /api/programs
- GET    /api/programs/:id
- GET    /api/programs/:id/download
- PUT    /api/programs/:id
- DELETE /api/programs/:id

### **Test:**
- POST /api/test/upload

---

## ğŸ§ª Testing-Ergebnisse

**Alle Tests erfolgreich durchgefÃ¼hrt:**
```
âœ… File Upload funktioniert
âœ… Program CREATE funktioniert
âœ… Program GET ALL funktioniert
âœ… Program GET BY ID funktioniert
âœ… Program GET BY OPERATION funktioniert
âœ… Program UPDATE funktioniert
âœ… Program DOWNLOAD funktioniert
âœ… Program DELETE funktioniert
âœ… Error Handling funktioniert
```

**Bug gefunden & gefixt:**
- âŒ Spaltenname-Fehler bei GET /api/programs
- âœ… Fix: AS-Aliase fÃ¼r op_number/op_name

---

## ğŸ“Š DB-Schema (Programme)

### **programs:**
```sql
id                    SERIAL PRIMARY KEY
operation_id          INTEGER REFERENCES operations
program_number        VARCHAR(50) NOT NULL
program_name          VARCHAR(255) NOT NULL
description           TEXT
current_revision_id   INTEGER REFERENCES program_revisions
workflow_state_id     INTEGER REFERENCES workflow_states
created_by            INTEGER REFERENCES users
created_at            TIMESTAMP
updated_at            TIMESTAMP
```

### **program_revisions:**
```sql
id                    SERIAL PRIMARY KEY
program_id            INTEGER REFERENCES programs
version_major         INTEGER DEFAULT 1
version_minor         INTEGER DEFAULT 0
version_patch         INTEGER DEFAULT 0
version_string        VARCHAR(20)
filename              VARCHAR(255)
filepath              VARCHAR(500)
filesize              INTEGER
file_hash             VARCHAR(64) (SHA-256)
mime_type             VARCHAR(100)
content               TEXT (File-Content)
diff_from_previous    TEXT
comment               TEXT
is_cam_original       BOOLEAN
optimized_by_user_id  INTEGER REFERENCES users
workflow_state_id     INTEGER REFERENCES workflow_states
released_by           INTEGER REFERENCES users
released_at           TIMESTAMP
created_by            INTEGER REFERENCES users
created_at            TIMESTAMP
```

---

## ğŸ¯ Noch offen (Frontend)

- [ ] ProgramsList Component
- [ ] ProgramCard Component
- [ ] ProgramUploadForm Component (Drag & Drop)
- [ ] ProgramViewer Component (Optional)
- [ ] Integration in PartDetailPage (Tab "Programme")

**GeschÃ¤tzte Zeit:** 4-5 Stunden

---

## ğŸ“ Wichtige Erkenntnisse

1. **Multer sehr einfach zu integrieren** - File Upload in 30min
2. **File-Hash wichtig** - SHA-256 erkennt Duplikate
3. **Content in DB speichern** - ErmÃ¶glicht Syntax-Highlighting spÃ¤ter
4. **Transaction-Support notwendig** - Program + Revision mÃ¼ssen atomar sein
5. **AS-Aliase fÃ¼r DB-Spalten** - Einheitliche API-Response

---

## ğŸš€ NÃ¤chste Schritte

**NÃ¤chste Session: Woche 6 Frontend**
1. ProgramsList Component
2. ProgramCard Component
3. ProgramUploadForm Component (Drag & Drop)
4. Integration in PartDetailPage

**GeschÃ¤tzte Zeit:** 4-5 Stunden

---

## ğŸ’¡ Notizen

- **Versionierung (Woche 7):** Neue Revision hochladen, Diff berechnen
- **File-Typen:** 15 verschiedene Steuerungen unterstÃ¼tzt
- **Performance:** File-Hash Berechnung kann bei groÃŸen Files dauern (100MB)
- **Cleanup:** Files werden bei Fehler automatisch gelÃ¶scht

---

**Session Ende:** âœ… Backend KOMPLETT  
**Status:** Bereit fÃ¼r Frontend Integration  
**NÃ¤chste Session:** Woche 6 Frontend - Programs Components
