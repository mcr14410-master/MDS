###
### Phase 3: Supplier Management - API Tests
###
### Test File für Supplier-Endpoints
###

@baseUrl = http://localhost:5000
@token = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwidXNlcm5hbWUiOiJhZG1pbiIsImVtYWlsIjoiYWRtaW5AZXhhbXBsZS5jb20iLCJpYXQiOjE3NjMzMjEzMTcsImV4cCI6MTc2MzQwNzcxN30.SsqwlMrZkhuU7Who63SLLUGE6UJmvUwfttvaAI9luSs

###############################################################################
# 1. SUPPLIERS - CRUD OPERATIONS
###############################################################################

### 1.1 Create Supplier #1 - Garant Werkzeugfabrik
POST {{baseUrl}}/api/suppliers
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "name": "Garant Werkzeugfabrik",
  "supplier_code": "GAR",
  "contact_person": "Hans Müller",
  "email": "sales@garant.de",
  "phone": "+49 711 12345-0",
  "fax": "+49 711 12345-99",
  "website": "https://www.garant.de",
  "address_line1": "Werkzeugstraße 10",
  "postal_code": "70563",
  "city": "Stuttgart",
  "country": "Deutschland",
  "payment_terms": "30 Tage netto",
  "delivery_time_days": 3,
  "minimum_order_value": 50.00,
  "currency": "EUR",
  "rating": 5,
  "is_preferred": true,
  "notes": "Hauptlieferant für HSS-Werkzeuge"
}

### 1.2 Create Supplier #2 - Sandvik Coromant
POST {{baseUrl}}/api/suppliers
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "name": "Sandvik Coromant",
  "supplier_code": "SANDVIK",
  "contact_person": "Anna Schmidt",
  "email": "info@sandvik.coromant.com",
  "phone": "+49 211 87654-0",
  "website": "https://www.sandvik.coromant.com",
  "address_line1": "Industriepark 5",
  "postal_code": "40474",
  "city": "Düsseldorf",
  "country": "Deutschland",
  "payment_terms": "60 Tage netto",
  "delivery_time_days": 5,
  "minimum_order_value": 100.00,
  "currency": "EUR",
  "rating": 5,
  "is_preferred": true,
  "notes": "Premium-Lieferant für Hartmetall und Wendeschneidplatten"
}

### 1.3 Create Supplier #3 - Hoffmann Group
POST {{baseUrl}}/api/suppliers
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "name": "Hoffmann Group",
  "supplier_code": "HOFF",
  "contact_person": "Peter Wagner",
  "email": "service@hoffmann-group.com",
  "phone": "+49 89 8391-0",
  "website": "https://www.hoffmann-group.com",
  "address_line1": "Haberlandstraße 55",
  "postal_code": "81241",
  "city": "München",
  "country": "Deutschland",
  "payment_terms": "30 Tage netto",
  "delivery_time_days": 2,
  "minimum_order_value": 0,
  "currency": "EUR",
  "rating": 4,
  "is_preferred": false,
  "notes": "Schnelle Lieferung für Standardwerkzeuge"
}

### 1.4 Get All Suppliers
GET {{baseUrl}}/api/suppliers
Authorization: Bearer {{token}}

### 1.5 Get All Suppliers - Filter by Active
GET {{baseUrl}}/api/suppliers?is_active=true
Authorization: Bearer {{token}}

### 1.6 Get All Suppliers - Filter by Preferred
GET {{baseUrl}}/api/suppliers?is_preferred=true
Authorization: Bearer {{token}}

### 1.7 Get All Suppliers - Search by Name
GET {{baseUrl}}/api/suppliers?search=Garant
Authorization: Bearer {{token}}

### 1.8 Get All Suppliers - Sort by Rating DESC
GET {{baseUrl}}/api/suppliers?sort_by=rating&sort_order=desc
Authorization: Bearer {{token}}

### 1.9 Get Supplier by ID
GET {{baseUrl}}/api/suppliers/1
Authorization: Bearer {{token}}

### 1.10 Update Supplier
PUT {{baseUrl}}/api/suppliers/1
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "contact_person": "Franz Meier",
  "phone": "+49 711 12345-100",
  "rating": 5,
  "notes": "Hauptlieferant für HSS-Werkzeuge - Sehr zuverlässig"
}

### 1.11 Deactivate Supplier (Soft Delete)
DELETE {{baseUrl}}/api/suppliers/3
Authorization: Bearer {{token}}

### 1.12 Delete Supplier (Hard Delete) - only if no items linked
DELETE {{baseUrl}}/api/suppliers/3?hard_delete=true
Authorization: Bearer {{token}}

###############################################################################
# 2. SUPPLIER ITEMS - Link Suppliers to Storage Items
###############################################################################

### 2.1 Link Supplier to Storage Item
# Requires: storage_item_id from storage_items table
POST {{baseUrl}}/api/supplier-items
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "storage_item_id": 1,
  "supplier_id": 1,
  "supplier_part_number": "GAR-10-HSS-TiAlN",
  "supplier_description": "HSS Bohrer Ø10mm mit TiAlN Beschichtung",
  "unit_price": 45.50,
  "currency": "EUR",
  "price_valid_from": "2024-11-01",
  "price_valid_until": "2025-12-31",
  "min_order_quantity": 1,
  "package_quantity": 1,
  "lead_time_days": 3,
  "is_preferred": true,
  "notes": "Bevorzugter Lieferant - beste Qualität"
}

### 2.2 Link Alternative Supplier to Same Item
POST {{baseUrl}}/api/supplier-items
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "storage_item_id": 1,
  "supplier_id": 2,
  "supplier_part_number": "SANDVIK-AB-10-123",
  "supplier_description": "Alternative zu Garant",
  "unit_price": 52.00,
  "currency": "EUR",
  "min_order_quantity": 5,
  "package_quantity": 5,
  "lead_time_days": 5,
  "is_preferred": false,
  "notes": "Alternative falls Garant nicht verfügbar"
}

### 2.3 Get All Suppliers for a Storage Item
GET {{baseUrl}}/api/storage/items/1/suppliers
Authorization: Bearer {{token}}

### 2.4 Update Supplier Item (Price, Lead Time, etc.)
PUT {{baseUrl}}/api/supplier-items/1
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "unit_price": 47.00,
  "price_valid_from": "2024-11-16",
  "price_valid_until": "2025-06-30",
  "notes": "Preiserhöhung um 3% ab November 2024"
}

### 2.5 Set Preferred Supplier
PUT {{baseUrl}}/api/supplier-items/2/preferred
Authorization: Bearer {{token}}

### 2.6 Remove Supplier from Item
DELETE {{baseUrl}}/api/supplier-items/2
Authorization: Bearer {{token}}

###############################################################################
# 3. SUPPLIER ITEMS - View Items from Supplier
###############################################################################

### 3.1 Get All Items from Supplier
GET {{baseUrl}}/api/suppliers/1/items
Authorization: Bearer {{token}}

###############################################################################
# 4. INTEGRATION TESTS
###############################################################################

### 4.1 Create Complete Workflow
# 1. Create Supplier
# 2. Link to Storage Item
# 3. Set Prices and Lead Times
# 4. View Supplier Details with Item Count

### Step 1: Create New Supplier
POST {{baseUrl}}/api/suppliers
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "name": "Local Tool Shop",
  "supplier_code": "LTS",
  "email": "info@localtoolshop.de",
  "phone": "+49 89 123456",
  "city": "München",
  "country": "Deutschland",
  "payment_terms": "Barzahlung",
  "delivery_time_days": 1,
  "rating": 3,
  "is_preferred": false
}

### Step 2: Link to Storage Item (use supplier_id from Step 1)
POST {{baseUrl}}/api/supplier-items
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "storage_item_id": 1,
  "supplier_id": 4,
  "supplier_part_number": "LTS-DRILL-10",
  "unit_price": 35.00,
  "currency": "EUR",
  "lead_time_days": 1,
  "is_preferred": false,
  "notes": "Notfall-Lieferant bei akutem Bedarf"
}

### Step 3: View Supplier with Item Count
GET {{baseUrl}}/api/suppliers/4
Authorization: Bearer {{token}}

### Step 4: View All Items from this Supplier
GET {{baseUrl}}/api/suppliers/4/items
Authorization: Bearer {{token}}

###############################################################################
# 5. ERROR CASES - Testing Validation
###############################################################################

### 5.1 Create Supplier without Required Name
POST {{baseUrl}}/api/suppliers
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "supplier_code": "TEST",
  "email": "test@test.de"
}

### 5.2 Create Duplicate Supplier Name
POST {{baseUrl}}/api/suppliers
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "name": "Garant Werkzeugfabrik",
  "supplier_code": "GAR2"
}

### 5.3 Create Supplier with Invalid Rating
POST {{baseUrl}}/api/suppliers
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "name": "Invalid Rating Supplier",
  "rating": 10
}

### 5.4 Link Supplier to Non-Existent Storage Item
POST {{baseUrl}}/api/supplier-items
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "storage_item_id": 99999,
  "supplier_id": 1,
  "unit_price": 10.00
}

### 5.5 Link Supplier to Item Twice (Duplicate)
POST {{baseUrl}}/api/supplier-items
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "storage_item_id": 1,
  "supplier_id": 1,
  "unit_price": 10.00
}

###############################################################################
# TEST SUMMARY
###############################################################################

# ✅ Suppliers CRUD (Create, Read, Update, Delete)
# ✅ Supplier Items (Link, Update, Remove)
# ✅ Filtering (Active, Preferred, Search)
# ✅ Sorting (Name, Rating, etc.)
# ✅ Get Items by Supplier
# ✅ Get Suppliers by Item
# ✅ Set Preferred Supplier
# ✅ Validation Error Cases
# ✅ Integration Workflow

###############################################################################
# NOTES
###############################################################################

# Remember to:
# 1. Replace {{token}} with actual JWT token from login
# 2. Replace storage_item_id with actual IDs from your database
# 3. Run migrations first: npm run migrate:latest
# 4. Start backend: npm run dev
# 5. Test each endpoint systematically

###############################################################################
