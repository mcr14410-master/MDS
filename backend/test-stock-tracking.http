###############################################################################
# MDS - Stock Tracking & Movements API Tests
# Batch 2.3 - Storage Items + Condition Tracking
###############################################################################

### SETUP: Variables
@baseUrl = http://localhost:5000/api
@authToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwidXNlcm5hbWUiOiJhZG1pbiIsImVtYWlsIjoiYWRtaW5AZXhhbXBsZS5jb20iLCJpYXQiOjE3NjMxNTgzNTMsImV4cCI6MTc2MzI0NDc1M30.NZLKGfaHong0X_7lVYxFJENurPotgWnIYGMN-KVbY4Q

### AUTH: Login to get token
# Run this first to get a valid token
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "admin123"
}

###############################################################################
# 1. STORAGE ITEMS - CRUD
###############################################################################

### 1.1 Get all storage items (with stock info)
GET {{baseUrl}}/storage/items
Authorization: Bearer {{authToken}}

### 1.2 Get all storage items - filter by tool_master_id
GET {{baseUrl}}/storage/items?tool_master_id=1
Authorization: Bearer {{authToken}}

### 1.3 Get all storage items - only low stock
GET {{baseUrl}}/storage/items?is_low_stock=true
Authorization: Bearer {{authToken}}

### 1.4 Get storage item by ID
GET {{baseUrl}}/storage/items/1
Authorization: Bearer {{authToken}}

### 1.5 Create new storage item with initial quantities
POST {{baseUrl}}/storage/items
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "item_type": "tool",
  "tool_master_id": 1,
  "compartment_id": 1,
  "quantity_new": 10,
  "quantity_used": 5,
  "quantity_reground": 3,
  "weight_new": 1.0,
  "weight_used": 0.5,
  "weight_reground": 0.8,
  "reorder_point": 6,
  "enable_low_stock_alert": true,
  "notes": "Test storage item with condition tracking"
}

### 1.6 Update storage item (reorder point and weights)
PUT {{baseUrl}}/storage/items/1
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "reorder_point": 8,
  "weight_new": 1.0,
  "weight_used": 0.6,
  "weight_reground": 0.85,
  "enable_low_stock_alert": true
}

### 1.7 Delete storage item
DELETE {{baseUrl}}/storage/items/999
Authorization: Bearer {{authToken}}

###############################################################################
# 2. STOCK OPERATIONS - ISSUE (Entnahme)
###############################################################################

### 2.1 Issue stock - NEW condition
POST {{baseUrl}}/storage/items/1/issue
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "new",
  "quantity": 2,
  "reason": "Entnahme für Auftrag #12345",
  "reference_type": "production_order",
  "reference_id": 12345
}

### 2.2 Issue stock - USED condition
POST {{baseUrl}}/storage/items/1/issue
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "used",
  "quantity": 1,
  "reason": "Testlauf Maschine M001"
}

### 2.3 Issue stock - REGROUND condition
POST {{baseUrl}}/storage/items/1/issue
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "reground",
  "quantity": 1.5,
  "reason": "Nacharbeit Bauteil P-2024-001"
}

### 2.4 Issue stock - ERROR: Not enough in stock
POST {{baseUrl}}/storage/items/1/issue
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "new",
  "quantity": 999,
  "reason": "Test: Zu viel entnehmen"
}

### 2.5 Issue stock - ERROR: Invalid condition
POST {{baseUrl}}/storage/items/1/issue
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "invalid",
  "quantity": 1,
  "reason": "Test: Ungültiger Zustand"
}

###############################################################################
# 3. STOCK OPERATIONS - RECEIVE (Einlagerung)
###############################################################################

### 3.1 Receive stock - NEW condition (from supplier)
POST {{baseUrl}}/storage/items/1/receive
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "new",
  "quantity": 25,
  "reason": "Wareneingang von Garant GmbH",
  "reference_type": "purchase_order",
  "reference_id": 5001
}

### 3.2 Receive stock - USED condition (returned from production)
POST {{baseUrl}}/storage/items/1/receive
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "used",
  "quantity": 3,
  "reason": "Rückgabe aus Produktion (Auftrag abgeschlossen)"
}

### 3.3 Receive stock - REGROUND condition (from regrinding service)
POST {{baseUrl}}/storage/items/1/receive
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "reground",
  "quantity": 5,
  "reason": "Nachgeschliffen bei Werkzeugservice ABC",
  "notes": "Rechnung #WS-2024-042"
}

### 3.4 Receive stock - ERROR: Invalid quantity
POST {{baseUrl}}/storage/items/1/receive
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "new",
  "quantity": -5,
  "reason": "Test: Negative Menge"
}

###############################################################################
# 4. STOCK OPERATIONS - TRANSFER (Umlagerung)
###############################################################################

### 4.1 Transfer stock - NEW condition to different compartment
POST {{baseUrl}}/storage/items/1/transfer
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "new",
  "quantity": 5,
  "to_compartment_id": 2,
  "reason": "Umlagerung zu Maschine M002"
}

### 4.2 Transfer stock - USED condition
POST {{baseUrl}}/storage/items/1/transfer
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "used",
  "quantity": 2,
  "to_compartment_id": 3,
  "reason": "Verschrottungs-Sammelbehälter",
  "notes": "Vorbereitung für Entsorgung"
}

### 4.3 Transfer stock - ERROR: Not enough in stock
POST {{baseUrl}}/storage/items/1/transfer
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "new",
  "quantity": 999,
  "to_compartment_id": 2,
  "reason": "Test: Zu viel umlagern"
}

###############################################################################
# 5. STOCK OPERATIONS - ADJUST (Korrektur/Inventur)
###############################################################################

### 5.1 Adjust stock - NEW condition (inventory correction)
POST {{baseUrl}}/storage/items/1/adjust
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "new",
  "new_quantity": 12,
  "reason": "Inventur 2024-11: Zähldifferenz korrigiert",
  "notes": "Gezählt von: M. Müller"
}

### 5.2 Adjust stock - USED condition (correction after regrinding)
POST {{baseUrl}}/storage/items/1/adjust
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "used",
  "new_quantity": 8,
  "reason": "Korrektur: 3 Stück wurden nachgeschliffen"
}

### 5.3 Adjust stock - REGROUND condition
POST {{baseUrl}}/storage/items/1/adjust
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "reground",
  "new_quantity": 6,
  "reason": "Inventur-Korrektur"
}

### 5.4 Adjust stock - ERROR: Negative quantity
POST {{baseUrl}}/storage/items/1/adjust
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "new",
  "new_quantity": -5,
  "reason": "Test: Negative Menge"
}

###############################################################################
# 6. STOCK OPERATIONS - SCRAP (Verschrottung)
###############################################################################

### 6.1 Scrap stock - USED condition (worn out tools)
POST {{baseUrl}}/storage/items/1/scrap
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "used",
  "quantity": 3,
  "reason": "Werkzeuge verschlissen - nicht mehr verwendbar",
  "notes": "Entsorgt am: 2024-11-14"
}

### 6.2 Scrap stock - REGROUND condition (broken after regrinding)
POST {{baseUrl}}/storage/items/1/scrap
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "reground",
  "quantity": 1,
  "reason": "Werkzeug gebrochen beim Schleifen"
}

### 6.3 Scrap stock - NEW condition (quality issue)
POST {{baseUrl}}/storage/items/1/scrap
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "new",
  "quantity": 2,
  "reason": "Qualitätsmangel vom Hersteller - Rücksendung nicht möglich"
}

### 6.4 Scrap stock - ERROR: Not enough in stock
POST {{baseUrl}}/storage/items/1/scrap
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "new",
  "quantity": 999,
  "reason": "Test: Zu viel verschrotten"
}

###############################################################################
# 7. STOCK MOVEMENTS - HISTORY
###############################################################################

### 7.1 Get movements by storage item
GET {{baseUrl}}/stock-movements/item/1
Authorization: Bearer {{authToken}}

### 7.2 Get movements by storage item (with pagination)
GET {{baseUrl}}/stock-movements/item/1?limit=10&offset=0
Authorization: Bearer {{authToken}}

### 7.3 Get single movement by ID
GET {{baseUrl}}/stock-movements/1
Authorization: Bearer {{authToken}}

### 7.4 Get all movements (no filter)
GET {{baseUrl}}/stock-movements
Authorization: Bearer {{authToken}}

### 7.5 Get all movements - filter by movement_type
GET {{baseUrl}}/stock-movements?movement_type=issue
Authorization: Bearer {{authToken}}

### 7.6 Get all movements - filter by condition
GET {{baseUrl}}/stock-movements?condition=new
Authorization: Bearer {{authToken}}

### 7.7 Get all movements - filter by tool_master_id
GET {{baseUrl}}/stock-movements?tool_master_id=1
Authorization: Bearer {{authToken}}

### 7.8 Get all movements - filter by date range
GET {{baseUrl}}/stock-movements?date_from=2024-11-01&date_to=2024-11-30
Authorization: Bearer {{authToken}}

### 7.9 Get all movements - multiple filters
GET {{baseUrl}}/stock-movements?movement_type=issue&condition=new&limit=20
Authorization: Bearer {{authToken}}

### 7.10 Get movement statistics
GET {{baseUrl}}/stock-movements/stats
Authorization: Bearer {{authToken}}

### 7.11 Get movement statistics - filtered by tool
GET {{baseUrl}}/stock-movements/stats?tool_master_id=1
Authorization: Bearer {{authToken}}

### 7.12 Get movement statistics - filtered by date range
GET {{baseUrl}}/stock-movements/stats?date_from=2024-11-01&date_to=2024-11-30
Authorization: Bearer {{authToken}}

###############################################################################
# 8. COMPLEX SCENARIOS
###############################################################################

### 8.1 Complete workflow: Create → Receive → Issue → Adjust → Transfer
# Step 1: Create storage item
POST {{baseUrl}}/storage/items
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "item_type": "tool",
  "tool_master_id": 2,
  "compartment_id": 1,
  "quantity_new": 0,
  "quantity_used": 0,
  "quantity_reground": 0,
  "reorder_point": 5,
  "enable_low_stock_alert": true
}

### 8.2 Step 2: Receive initial stock
POST {{baseUrl}}/storage/items/2/receive
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "new",
  "quantity": 20,
  "reason": "Erstbestand aus Wareneingang"
}

### 8.3 Step 3: Issue some tools
POST {{baseUrl}}/storage/items/2/issue
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "new",
  "quantity": 5,
  "reason": "Produktion Auftrag #100"
}

### 8.4 Step 4: Receive used tools back
POST {{baseUrl}}/storage/items/2/receive
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "used",
  "quantity": 3,
  "reason": "Rückgabe aus Produktion"
}

### 8.5 Step 5: Send used tools to regrinding
POST {{baseUrl}}/storage/items/2/issue
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "used",
  "quantity": 3,
  "reason": "Zum Nachschleifen geschickt"
}

### 8.6 Step 6: Receive reground tools back
POST {{baseUrl}}/storage/items/2/receive
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "reground",
  "quantity": 3,
  "reason": "Zurück vom Nachschleifen"
}

### 8.7 Step 7: Check current stock
GET {{baseUrl}}/storage/items/2
Authorization: Bearer {{authToken}}

### 8.8 Step 8: Get complete movement history
GET {{baseUrl}}/stock-movements/item/2
Authorization: Bearer {{authToken}}

###############################################################################
# 9. ERROR CASES & VALIDATION
###############################################################################

### 9.1 Missing permission - try to issue without stock.issue permission
# (Requires user with limited permissions)
POST {{baseUrl}}/storage/items/1/issue
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "new",
  "quantity": 1,
  "reason": "Test"
}

### 9.2 Invalid storage item ID
GET {{baseUrl}}/storage/items/99999
Authorization: Bearer {{authToken}}

### 9.3 Missing required fields
POST {{baseUrl}}/storage/items/1/issue
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "new"
}

### 9.4 Invalid condition value
POST {{baseUrl}}/storage/items/1/issue
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "broken",
  "quantity": 1,
  "reason": "Test"
}

### 9.5 Zero quantity
POST {{baseUrl}}/storage/items/1/receive
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "condition": "new",
  "quantity": 0,
  "reason": "Test"
}

###############################################################################
# END OF TESTS
###############################################################################
